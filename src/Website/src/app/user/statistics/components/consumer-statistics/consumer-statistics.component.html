<app-merchant-search
  [currentUser]="currentUser"
  (consumptionVoucherData)="consumptionVoucherData($event)"
  (clearElementFilter)="clearElementFilter($event)"
></app-merchant-search>
<!-- WOM Consumati Section -->
<div *ngIf="isConsumedDataReady; else loadingConsumption" class="mt-6">
  <div
    class="flex flex-wrap justify-center gap-10 card-stat max-w-fit min-w-[530px]"
  >
    <!-- Total Section -->
    <div class="flex gap-2 items-center">
      <p class="font-semibold">Totali:</p>
      <ng-container
        *ngIf="consumedStats.consumedInPeriod; else zeroConsumedAmount"
      >
        <app-animated-number
          [finalNumber]="consumedStats.consumedInPeriod"
          [duration]="1000"
        ></app-animated-number>
      </ng-container>
      <ng-template #zeroConsumedAmount>
        <p>0</p>
      </ng-template>
    </div>
    <!-- Transaction Number -->
    <div class="flex gap-2 items-center">
      <p class="font-semibold">Numero transazioni:</p>
      <ng-container
        *ngIf="consumedStats.transactionsInPeriod; else zeroConsumedAmount"
      >
        <app-animated-number
          [finalNumber]="consumedStats.transactionsInPeriod"
          [duration]="1000"
        ></app-animated-number>
      </ng-container>
      <ng-template #zeroConsumedAmount>
        <p>0</p>
      </ng-template>
    </div>
    <!-- Total Ever Section -->
    <div class="flex gap-2 items-center">
      <p class="font-semibold">Totale di sempre:</p>
      <ng-container
        *ngIf="consumedStats.totalConsumed; else zeroConsumedAmount"
      >
        <app-animated-number
          [finalNumber]="consumedStats.totalConsumed"
          [duration]="1000"
        ></app-animated-number>
      </ng-container>
      <ng-template #zeroConsumedAmount>
        <p>0</p>
      </ng-template>
    </div>
    <!-- Total ever transaction -->
    <div class="flex gap-2 items-center">
      <p class="font-semibold">Totale di sempre:</p>
      <ng-container
        *ngIf="consumedStats.totalTransactions; else zeroConsumedAmount"
      >
        <app-animated-number
          [finalNumber]="consumedStats.totalTransactions"
          [duration]="1000"
        ></app-animated-number>
      </ng-container>
      <ng-template #zeroConsumedAmount>
        <p>0</p>
      </ng-template>
    </div>
    <!-- AVAILABLE WOM -->
    <div
      *ngIf="
        availableVouchers !== undefined && availableVouchers !== null;
        else loadingAvailableVouchers
      "
      class="flex gap-2"
    >
      <p>Restano</p>
      <app-animated-number
        [finalNumber]="availableVouchers"
        [duration]="1000"
      ></app-animated-number>
      <p>WOM <strong>disponibili</strong></p>
    </div>
    <ng-template #loadingAvailableVouchers>
      <ngx-skeleton-loader
        class="skeleton-class"
        count="1"
        appearance="line"
        [theme]="{
          height: '28px',
          width: '280px',
          'border-radius': '20px',
          'margin-bottom': '0px'
        }"
      ></ngx-skeleton-loader>
    </ng-template>
  </div>

  <!-- Bar Chart for Consumption over Time -->
  <div class="flex flex-col lg:flex-row gap-2 mt-2">
    <div>
      <div
        class="card-stat"
        *ngIf="totalConsumedOverTime && consumedStats.consumedInPeriod > 0"
      >
        <ng-container>
          <p class="font-semibold">Consumo nel tempo</p>
          <ngx-charts-bar-vertical
            [view]="view"
            [scheme]="blueWomScheme"
            [results]="totalConsumedOverTime"
            [gradient]="false"
            [xAxis]="true"
            [yAxis]="true"
            [legend]="false"
            [showXAxisLabel]="true"
            [showYAxisLabel]="true"
            [xAxisLabel]="'Data'"
            [yAxisLabel]="'QuantitÃ '"
            (select)="onSelect($event)"
          >
          </ngx-charts-bar-vertical>
        </ng-container>
      </div>
    </div>
    <!-- BEGIN Merchant Ranking -->
    <div
      class="card-stat max-w-fit"
      *ngIf="
        consumedStats.merchantRanks && consumedStats.merchantRanks.length > 0
      "
    >
      <h3 class="font-semibold mb-4">
        <i class="fa-solid fa-star" style="color: #ffd43b"></i> Classifica
        Merchant
      </h3>
      <ul class="pl-5 space-y-2 h-[450px] overflow-y-auto list-none">
        <li *ngFor="let rank of consumedStats.merchantRanks">
          <!-- Conditional rendering for trophy icon based on rank -->
          <span *ngIf="rank.rank === 1">
            1) <i class="fa-solid fa-trophy" style="color: #ffd43b"></i>
          </span>
          <span *ngIf="rank.rank === 2">
            2) <i class="fa-solid fa-trophy" style="color: #c0c0c0"></i>
          </span>
          <span *ngIf="rank.rank === 3">
            3) <i class="fa-solid fa-trophy" style="color: #cd7f32"></i>
          </span>
          <span *ngIf="rank.rank > 3"> {{ rank.rank }}) </span>
          {{ rank.name }}: <strong>{{ rank.amount }}</strong>
          <span class="italic text-xs"> WOM</span>
        </li>
      </ul>
    </div>

    <!-- END Merchant Ranking -->
  </div>
</div>
<ng-template #loadingConsumption>
  <div
    class="flex flex-col gap-4 p-6 bg-white shadow-md rounded-lg w-[530px] mb-10"
  >
    <ngx-skeleton-loader
      count="1"
      appearance="line"
      [theme]="{
        height: '50px',
        width: '180px',
        'border-radius': '20px'
      }"
    ></ngx-skeleton-loader>
  </div>
  <div
    class="flex flex-col gap-4 p-6 bg-white shadow-md rounded-lg min-w-[1000px]"
  >
    <ngx-skeleton-loader
      count="1"
      appearance="line"
      [theme]="{
        height: '50px',
        width: '180px',
        'border-radius': '20px'
      }"
    ></ngx-skeleton-loader>
    <div class="flex justify-around">
      <ngx-skeleton-loader
        count="1"
        appearance="line"
        [theme]="{
          height: '300px',
          width: '300px',
          'border-radius': '20px'
        }"
      ></ngx-skeleton-loader>
      <ngx-skeleton-loader
        count="1"
        appearance="circle"
        animation="progress-dark"
        [theme]="{ height: '300px', width: '300px' }"
      ></ngx-skeleton-loader>
    </div>
    <ngx-skeleton-loader
      count="5"
      [theme]="{
        'border-radius': '5px',
        height: '50px'
      }"
    ></ngx-skeleton-loader>
  </div>
</ng-template>
